# This file was generated by GoReleaser. DO NOT EDIT.
cask "vibe-zsh" do
  name "vibe-zsh"
  desc "Transform natural language into shell commands using AI"
  homepage "https://github.com/skymoore/vibe-zsh"
  version "0.3.0-beta.2"

  livecheck do
    skip "Auto-generated on release."
  end

  binary "vibe-zsh"
  depends_on formula: [
      "zsh",
    ]

  on_macos do
    on_intel do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-darwin-amd64.tar.gz"
      sha256 "fd8fa3d686b0433e87332347e730721abc1ad99a3106551382036d1a6d2b1a4b"
    end
    on_arm do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-darwin-arm64.tar.gz"
      sha256 "5a7bcfa9ab219110502063531580e7faa178a6d8236f47204607cc0d8bbc2a23"
    end
  end

  on_linux do
    on_intel do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-linux-amd64.tar.gz"
      sha256 "ce1255b46bab7027682ca36912d52c0026df0eb3d0d70d8fdae9d3c4588f2d5a"
    end
    on_arm do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-linux-arm64.tar.gz"
      sha256 "b61c6ba764b0b590ec65cdbeee61e9e21646b302cdf7f160238c2cc2c93e79e0"
    end
  end

  postflight do
    require 'fileutils'

    oh_my_zsh_dir = "#{Dir.home}/.oh-my-zsh"
    custom_plugins_dir = "#{oh_my_zsh_dir}/custom/plugins"
    vibe_plugin_dir = "#{custom_plugins_dir}/vibe"
    zshrc_path = "#{Dir.home}/.zshrc"

    binary_link = "/opt/homebrew/bin/vibe-zsh"
    if File.exist?(binary_link) && File.symlink?(binary_link)
      install_path = File.readlink(binary_link)
    else
      install_path = staged_path
    end

    unless Dir.exist?(oh_my_zsh_dir)
      puts "Warning: Oh My Zsh is not installed. vibe requires Oh My Zsh for Ctrl+G functionality."
      puts "Please install Oh My Zsh: sh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\""
      puts "After installation, add 'vibe' to your plugins in ~/.zshrc and run: source ~/.zshrc"
      exit 0
    end

    FileUtils.mkdir_p(custom_plugins_dir) unless Dir.exist?(custom_plugins_dir)

    if Dir.exist?(vibe_plugin_dir)
      FileUtils.rm_rf(vibe_plugin_dir)
    end
    FileUtils.mkdir_p(vibe_plugin_dir)

    ["vibe", "vibe.plugin.zsh", "_vibe", "LICENSE", "README.md"].each do |file|
      src = File.join(install_path, file)
      dst = File.join(vibe_plugin_dir, file)
      if File.exist?(src)
        FileUtils.cp(src, dst)
        FileUtils.chmod(0755, dst) if file == "vibe"
      end
    end

    homebrew_bin = "/opt/homebrew/bin"
    vibe_zsh_symlink = File.join(homebrew_bin, "vibe-zsh")
    vibe_binary_in_plugin = File.join(vibe_plugin_dir, "vibe")

    if File.exist?(vibe_binary_in_plugin) && Dir.exist?(homebrew_bin)
      FileUtils.rm(vibe_zsh_symlink) if File.exist?(vibe_zsh_symlink) || File.symlink?(vibe_zsh_symlink)
      FileUtils.ln_s(vibe_binary_in_plugin, vibe_zsh_symlink)
      puts "✓ Created global symlink: /opt/homebrew/bin/vibe-zsh -> #{vibe_binary_in_plugin}"
      puts "✓ You can now use 'vibe-zsh' command globally"
    end

    zshrc_content = File.read(zshrc_path) rescue ""
    modified = false

    unless zshrc_content =~ /\bvibe\b/ && zshrc_content =~ /plugins=/
      if zshrc_content.match?(/plugins=\(([\s\S]*?)\)/m)
        zshrc_content.gsub!(/plugins=\(([\s\S]*?)\)/m) do |m|
          plugins_list = $1.strip
          if plugins_list =~ /\bvibe\b/
            m
          elsif plugins_list.empty?
            "plugins=(vibe)"
          elsif plugins_list.include?("\n")
            "plugins=(#{plugins_list}\n  vibe\n)"
          else
            "plugins=(#{plugins_list} vibe)"
          end
        end
        modified = true
      else
        zshrc_content += "\nplugins=(vibe)\n"
        modified = true
      end
    end

    if modified
      File.write(zshrc_path, zshrc_content)
      puts "✓ Added vibe to plugins in ~/.zshrc"
    end

    puts "✓ vibe plugin installed to #{vibe_plugin_dir}"
    puts "✓ vibe setup complete. Please run: source ~/.zshrc"
  end

  caveats do
    "vibe has been installed successfully!"
    ""
    "For ZSH Plugin (Ctrl+G):"
    "  If Oh My Zsh is installed, vibe has been automatically configured."
    "  Please run: source ~/.zshrc"
    ""
    "  If Oh My Zsh is not installed, install it first:"
    "    sh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\""
    ""
    "  Then add 'vibe' to your plugins in ~/.zshrc:"
    "    plugins=(... vibe)"
    ""
    "For Direct CLI Usage:"
    "  The executable is available as: vibe-zsh"
    "  Example: vibe-zsh \"list all docker containers\""
    ""
    "Configure your AI provider (see https://github.com/skymoore/vibe-zsh#configuration):"
    "  export VIBE_API_URL=\"http://localhost:11434/v1\""
    "  export VIBE_MODEL=\"llama3:8b\""
    ""
    "Use Ctrl+G to transform natural language into commands!"
  end

  # No zap stanza required
end
