# This file was generated by GoReleaser. DO NOT EDIT.
cask "vibe-zsh" do
  name "vibe-zsh"
  desc "Transform natural language into shell commands using AI"
  homepage "https://github.com/skymoore/vibe-zsh"
  version "0.2.1-beta.19"

  livecheck do
    skip "Auto-generated on release."
  end

  binary "vibe-zsh"
  depends_on formula: [
      "zsh",
    ]

  on_macos do
    on_intel do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-darwin-amd64.tar.gz"
      sha256 "49717d4518348056972c465149fe5dd5e73acb575091f157aba8022d109477a1"
    end
    on_arm do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-darwin-arm64.tar.gz"
      sha256 "be2bba75e266ff5ccffa1f903b4be4ba2d38ea9234ca65fadc4160bf3fa6a1e8"
    end
  end

  on_linux do
    on_intel do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-linux-amd64.tar.gz"
      sha256 "ef41b171aec3054595cbc0c07c63ed5be974ee6a8466c91d546ef0147584f311"
    end
    on_arm do
      url "https://github.com/skymoore/vibe-zsh/releases/download/v#{version}/vibe-zsh-#{version}-linux-arm64.tar.gz"
      sha256 "91c1dc47f219f002286391540fa1eaf992452f9e51fb25af0d941677d1bda361"
    end
  end

  postflight do
    require 'fileutils'

    oh_my_zsh_dir = "#{Dir.home}/.oh-my-zsh"
    custom_plugins_dir = "#{oh_my_zsh_dir}/custom/plugins"
    vibe_plugin_dir = "#{custom_plugins_dir}/vibe"
    zshrc_path = "#{Dir.home}/.zshrc"

    binary_link = "/opt/homebrew/bin/vibe-zsh"
    if File.exist?(binary_link) && File.symlink?(binary_link)
      install_path = File.readlink(binary_link)
    else
      install_path = staged_path
    end

    unless Dir.exist?(oh_my_zsh_dir)
      puts "Warning: Oh My Zsh is not installed. vibe requires Oh My Zsh for Ctrl+G functionality."
      puts "Please install Oh My Zsh: sh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\""
      puts "After installation, add 'vibe' to your plugins in ~/.zshrc and run: source ~/.zshrc"
      exit 0
    end

    FileUtils.mkdir_p(custom_plugins_dir) unless Dir.exist?(custom_plugins_dir)

    if Dir.exist?(vibe_plugin_dir)
      FileUtils.rm_rf(vibe_plugin_dir)
    end
    FileUtils.mkdir_p(vibe_plugin_dir)

    ["vibe", "vibe.plugin.zsh", "_vibe", "LICENSE", "README.md"].each do |file|
      src = File.join(install_path, file)
      dst = File.join(vibe_plugin_dir, file)
      if File.exist?(src)
        FileUtils.cp(src, dst)
        FileUtils.chmod(0755, dst) if file == "vibe"
      end
    end

    zshrc_content = File.read(zshrc_path) rescue ""
    modified = false

    unless zshrc_content =~ /\bvibe\b/ && zshrc_content =~ /plugins=/
      if zshrc_content.match?(/plugins=\(([\s\S]*?)\)/m)
        zshrc_content.gsub!(/plugins=\(([\s\S]*?)\)/m) do |m|
          plugins_list = $1.strip
          if plugins_list =~ /\bvibe\b/
            m
          elsif plugins_list.empty?
            "plugins=(vibe)"
          elsif plugins_list.include?("\n")
            "plugins=(#{plugins_list}\n  vibe\n)"
          else
            "plugins=(#{plugins_list} vibe)"
          end
        end
        modified = true
      else
        zshrc_content += "\nplugins=(vibe)\n"
        modified = true
      end
    end

    if modified
      File.write(zshrc_path, zshrc_content)
      puts "✓ Added vibe to plugins in ~/.zshrc"
    end

    puts "✓ vibe plugin installed to #{vibe_plugin_dir}"
    puts "✓ vibe setup complete. Please run: source ~/.zshrc"
  end

  caveats do
    "vibe requires Oh My Zsh for Ctrl+G functionality."
    ""
    "If Oh My Zsh is installed, vibe has been automatically configured."
    "Please run: source ~/.zshrc"
    ""
    "If Oh My Zsh is not installed, install it first:"
    "  sh -c \"$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\""
    ""
    "Then add 'vibe' to your plugins in ~/.zshrc:"
    "  plugins=(... vibe)"
    ""
    "Configure your AI provider (see https://github.com/skymoore/vibe-zsh#configuration):"
    "  export VIBE_API_URL=\"http://localhost:11434/v1\""
    "  export VIBE_MODEL=\"llama3:8b\""
    ""
    "Use Ctrl+G to transform natural language into commands!"
  end

  # No zap stanza required
end
